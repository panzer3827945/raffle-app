<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¹´ä¼šæŠ½é¸ï¼ˆBingoï¼‰</title>

<script src="shared.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",Arial;
  background:linear-gradient(180deg,#fff4f2,#ffffff);
  text-align:center;
  padding:16px;
}
h2{margin:12px 0;font-weight:700}
.btn{
  width:90%;
  max-width:360px;
  padding:16px;
  margin:14px auto;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#c0392b,#8e2a1f);
  color:#fff;
  font-size:18px;
}
.stage{width:340px;height:340px;margin:14px auto;position:relative}
canvas{width:340px;height:340px}
.pointer{
  position:absolute;
  right:5px;
  top:50%;
  transform:translateY(-50%);
  width:0;
  height:0;
  border-top:14px solid transparent;
  border-bottom:14px solid transparent;
  border-right:28px solid #F1F3F6;
  filter: drop-shadow(0 0 4px rgba(0,0,0,.25));
}

#result{font-size:20px;font-weight:700;margin-top:8px}
</style>
</head>

<body>

<h2>ğŸ‰ å¹´ä¼šæŠ½é¸ï¼ˆBingoï¼‰</h2>
<button class="btn" onclick="location.href='index.html'">â† ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>

<div class="stage">
  <canvas id="wheel" width="340" height="340"></canvas>
  <div class="pointer"></div>
</div>

<button class="btn" onclick="startDraw()">æŠ½é¸ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
<div id="result"></div>

<script>
/* =====================================================
 * resetVersion åŒæ­¥ï¼ˆğŸ”¥çœŸæ­£å®Œæ•´ç‰ˆï¼‰
 * ===================================================== */
async function syncResetVersionBeforeDraw(){
  try{
    const r = await fetch("/api/reset-version",{cache:"no-store"});
    const d = await r.json();
    const sv = String(d.resetVersion);
    const lv = localStorage.getItem("resetVersion");

    if(lv !== sv){
      // ğŸ”¥ æ¸…æ‰æ‰€æœ‰ã€Œè¨­å‚™åˆ¤æ–·ã€ç›¸é—œè³‡æ–™
      localStorage.removeItem("used-limit");
      localStorage.removeItem("played");
      localStorage.removeItem("deviceId");

      localStorage.setItem("resetVersion", sv);
      console.log("reset synced:", sv);
    }
  }catch(e){}
}

/* =====================================================
 * è½‰ç›¤è¨­å®š
 * ===================================================== */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

const prizes = [
  { text:"5000", value:5000, weight:20, color:"#FA897B" }, // çŠç‘šç´…ï¼ˆä¸»çï¼‰
  { text:"3000",  value:3000,  weight:30, color:"#FFDD94" }, // å¥¶é»ƒï¼ˆæ¬¡çï¼‰
  { text:"2000",  value:2000,  weight:50, color:"#86E3CE" }  // è–„è·ï¼ˆå°çï¼‰
];
const total = prizes.reduce((s,p)=>s+p.weight,0);
let spinning = false;

function drawWheel(angle){
  ctx.clearRect(0,0,340,340);
  let start = angle;

  prizes.forEach(p=>{
    const arc = (p.weight / total) * Math.PI * 2;

    ctx.beginPath();
    ctx.moveTo(170,170);
    ctx.arc(170,170,140,start,start+arc);
    ctx.fillStyle = p.color;
    ctx.fill();

    // åˆ†éš”ç·šï¼ˆä½å­˜åœ¨æ„Ÿï¼‰
    ctx.lineWidth = 1.5;
    ctx.strokeStyle = "rgba(255,255,255,.35)";
    ctx.stroke();

    // æ–‡å­—ï¼ˆæ·±è‰²å­— + æ·ºæé‚Šï¼‰
    ctx.save();
    ctx.translate(170,170);
    ctx.rotate(start + arc / 2);
    ctx.textAlign = "center";
    ctx.font = "bold 21px Arial";

    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(255,255,255,.8)";
    ctx.strokeText(p.text,85,8);

    ctx.fillStyle = "#1F2D3D"; // æ·±ç°è—å­—
    ctx.fillText(p.text,85,8);
    ctx.restore();

    start += arc;
  });

  // å¤–æ¡†ï¼šæ”¹æˆä¸­æ€§è‰²ï¼ˆä¸æ¶ï¼‰
  ctx.beginPath();
  ctx.arc(170,170,145,0,Math.PI*2);
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#D6DCE5"; // æ·ºç°è—
  ctx.stroke();

  // ä¸­å¤®è»¸
  ctx.beginPath();
  ctx.arc(170,170,4,0,Math.PI*2);
  ctx.fillStyle = "#ffffff";
  ctx.fill();
}
drawWheel(0);

function prizeByAngle(angle){
  const a=((angle%(Math.PI*2))+Math.PI*2)%(Math.PI*2);
  let acc=0;
  for(const p of prizes){
    const arc=(p.weight/total)*Math.PI*2;
    if(a>=acc && a<acc+arc) return p.value;
    acc+=arc;
  }
  return prizes[0].value;
}

/* =====================================================
 * æŠ½çä¸»æµç¨‹ï¼ˆæœ€çµ‚å®‰å…¨ç‰ˆï¼‰
 * ===================================================== */
async function startDraw(){
  if(spinning) return;

  await syncResetVersionBeforeDraw();

  const name = localStorage.getItem("raffleName");
  if(!name) return alert("ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  spinning = true;
  result.innerText = "";

  const rnd = Math.random()*total;
  let accW=0,startAngle=0,targetArc=0;
  for(const p of prizes){
    if(rnd<accW+p.weight){
      targetArc=(p.weight/total)*Math.PI*2;
      break;
    }
    startAngle+=(p.weight/total)*Math.PI*2;
    accW+=p.weight;
  }

  const offset=Math.random()*targetArc;
  const finalAngle=(5+Math.random()*2)*Math.PI*2-(startAngle+offset);
  const t0=performance.now(),duration=4200;

  function anim(t){
    const p=Math.min((t-t0)/duration,1);
    drawWheel((1-Math.pow(1-p,3))*finalAngle);
    if(p<1) requestAnimationFrame(anim);
    else finish();
  }

  async function finish(){
    const prize=prizeByAngle((Math.PI*2-(finalAngle%(Math.PI*2)))%(Math.PI*2));
    await submitRecord(name,prize,"NOLIMIT");
    result.innerText=`${name} ã•ã‚“ï¼š${prize} å½“é¸`;
    spinning=false;
  }

  requestAnimationFrame(anim);
}
</script>

</body>
</html>


