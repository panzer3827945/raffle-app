<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">

<!-- âœ… æ‰‹æ©Ÿç‰ˆä¸€å®šè¦æœ‰ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- âœ… é˜²å¿«å–ï¼Œé¿å…èˆŠ JS -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>æŠ½çç´€éŒ„</title>

<style>
/* ===== åŸºæœ¬æ¨£å¼ ===== */
body {
  font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP", Arial, sans-serif;
  padding: 12px;
  margin: 0;
  background: #fafafa;
}

h2 {
  text-align: center;
  margin-bottom: 12px;
}

button {
  padding: 8px 12px;
  font-size: 14px;
  border: none;
  border-radius: 6px;
  background: #d35400;
  color: #fff;
  margin-right: 6px;
}

button:active {
  opacity: 0.8;
}

/* ===== è¡¨æ ¼æ¨£å¼ ===== */
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  margin-top: 12px;
  table-layout: fixed;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
  word-break: break-all;
}

th {
  background: #fdecea;
}

/* ===== æ‰‹æ©Ÿå„ªåŒ– ===== */
@media (max-width: 600px) {
  h2 {
    font-size: 18px;
  }

  button {
    width: 100%;
    margin: 4px 0;
    font-size: 15px;
  }

  th, td {
    font-size: 12px;
    padding: 4px;
  }

  /* è®“è¡¨æ ¼æ©«å‘å¯æ»‘å‹• */
  .table-wrap {
    overflow-x: auto;
  }
}
</style>
</head>

<body>

<h2>ğŸ“Š æŠ½çç´€éŒ„</h2>

<div>
  <button onclick="load()">ğŸ”„ é‡æ–°æ•´ç†</button>
  <button onclick="clearAll()">ğŸ—‘ æ¸…ç©ºç´€éŒ„</button>
</div>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>æ—¥æ™‚</th>
        <th>åå‰</th>
        <th>ãƒ¢ãƒ¼ãƒ‰</th>
        <th>è³å“</th>
        <th>ç«¯æœ«ID</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
/* ===== é¡¯ç¤ºæ¨¡å¼è½‰æ› ===== */
function displayMode(mode){
  if (mode === "LIMIT") return "ALL";
  if (mode === "NOLIMIT") return "BINGO";
  return mode || "";
}

/* =====================================================
 * resetVersion åŒæ­¥ï¼ˆé—œéµï¼‰
 * ===================================================== */
async function syncResetVersion(){
  try {
    const res = await fetch("/api/reset-version");
    if (!res.ok) return;

    const data = await res.json();
    const localVer = localStorage.getItem("resetVersion");

    if (localVer !== String(data.resetVersion)) {
      // âœ… æ¸…é™¤æ‰€æœ‰æŠ½çé™åˆ¶
      localStorage.clear();
      localStorage.setItem("resetVersion", String(data.resetVersion));
      console.log("resetVersion synced:", data.resetVersion);
    }
  } catch (e) {
    console.warn("resetVersion sync failed");
  }
}

/* =====================================================
 * è¼‰å…¥ç´€éŒ„
 * ===================================================== */
async function load(){
  await syncResetVersion();

  const res = await fetch("/api/history", { method: "POST" });

  if (!res.ok){
    alert("å–å¾—å¤±æ•—");
    return;
  }

  const data = await res.json();
  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.time || ""}</td>
      <td>${r.name || ""}</td>
      <td>${displayMode(r.mode)}</td>
      <td>${r.prize ?? ""}</td>
      <td>${r.device || ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* =====================================================
 * æ¸…ç©ºç´€éŒ„ï¼ˆåŒæ­¥æ‰€æœ‰è¨­å‚™ï¼‰
 * ===================================================== */
async function clearAll(){
  if (!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  const res = await fetch("/api/reset", { method: "POST" });

  if (!res.ok){
    alert("å‰Šé™¤å¤±æ•—");
    return;
  }

  const data = await res.json();

  // âœ… æ›´æ–° resetVersionï¼Œè®“æ‰€æœ‰è¨­å‚™å¯å†æŠ½
  localStorage.clear();
  if (data.resetVersion) {
    localStorage.setItem("resetVersion", String(data.resetVersion));
  }

  document.getElementById("rows").innerHTML = "";
  alert("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
}

/* é é¢æ‰“é–‹æ™‚è‡ªå‹•åŒæ­¥ä¸€æ¬¡ */
syncResetVersion();
</script>

</body>
</html>
